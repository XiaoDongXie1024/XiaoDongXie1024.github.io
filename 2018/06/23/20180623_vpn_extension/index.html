<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=6.4.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=6.4.2">


  <link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=6.4.2" color="#222">



  <meta name="msapplication-config" content="/images/browserconfig.xml" />







<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.4.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="iOS建立简单的VPN连接并成功拦截IP数据包pakcet。">
<meta name="keywords" content="iOS,VPN,App extension">
<meta property="og:type" content="article">
<meta property="og:title" content="App extension实战 - Personal VPN 连接并捕获packet">
<meta property="og:url" content="https://XiaoDongXie1024.github.io/2018/06/23/20180623_vpn_extension/index.html">
<meta property="og:site_name" content="小东邪 Show Time">
<meta property="og:description" content="iOS建立简单的VPN连接并成功拦截IP数据包pakcet。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b565134cc057?w=609&h=506&f=png&s=93467">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b56513944c9e?w=587&h=845&f=png&s=200777">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b56513e87746?w=553&h=145&f=png&s=28393">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b56513d8642d?w=706&h=498&f=png&s=159278">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b56514e6bbdd?w=764&h=560&f=png&s=67130">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b565151b642d?w=946&h=270&f=png&s=69441">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b5653b48f9e2?w=500&h=42&f=png&s=16563">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b5653ec6c2a7?w=495&h=396&f=png&s=39669">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b56541d65f39?w=1893&h=750&f=png&s=292199">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b565475d5369?w=962&h=491&f=png&s=148497">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b5654a5cab4c?w=1233&h=360&f=png&s=1365526">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b56552117f30?w=2000&h=97&f=png&s=192026">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b56560ee75ad?w=1500&h=604&f=png&s=532576">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b56568180f18?w=400&h=516&f=png&s=140440">
<meta property="og:updated_time" content="2018-10-24T10:25:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="App extension实战 - Personal VPN 连接并捕获packet">
<meta name="twitter:description" content="iOS建立简单的VPN连接并成功拦截IP数据包pakcet。">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2018/6/23/1642b565134cc057?w=609&h=506&f=png&s=93467">






  <link rel="canonical" href="https://XiaoDongXie1024.github.io/2018/06/23/20180623_vpn_extension/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>App extension实战 - Personal VPN 连接并捕获packet | 小东邪 Show Time</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小东邪 Show Time</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-桃花岛">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />桃花岛</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-时间轴">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />时间轴</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-武功秘籍">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />武功秘籍</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-江湖地位">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />江湖地位</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-江湖历程">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-futbol-o"></i> <br />江湖历程</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://XiaoDongXie1024.github.io/2018/06/23/20180623_vpn_extension/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小东邪 - Demon">
      <meta itemprop="description" content="一生负气成今日，四海无人对夕阳.">
      <meta itemprop="image" content="http://r.photo.store.qq.com/psb?/V14Id4Zj1TAt9e/yzeIpXHXXaOcxOnovNgST0jvIeuupEGzPfZ3DWoYrLY!/r/dFQBAAAAAAAA">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小东邪 Show Time">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">App extension实战 - Personal VPN 连接并捕获packet
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-06-23 14:38:19" itemprop="dateCreated datePublished" datetime="2018-06-23T14:38:19+08:00">2018-06-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-10-24 18:25:03" itemprop="dateModified" datetime="2018-10-24T18:25:03+08:00">2018-10-24</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/App-extension/" itemprop="url" rel="index"><span itemprop="name">App extension</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/23/20180623_vpn_extension/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count gitment-comments-count" data-xid="/2018/06/23/20180623_vpn_extension/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/06/23/20180623_vpn_extension/" class="leancloud_visitors" data-flag-title="App extension实战 - Personal VPN 连接并捕获packet">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views: </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          
              <div class="post-description">iOS建立简单的VPN连接并成功拦截IP数据包pakcet。</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p class="description"></p>

<a id="more"></a>
<h3 id="本例需求-iOS建立简单的VPN连接并成功拦截IP数据包pakcet"><a href="#本例需求-iOS建立简单的VPN连接并成功拦截IP数据包pakcet" class="headerlink" title="本例需求 : iOS建立简单的VPN连接并成功拦截IP数据包pakcet."></a>本例需求 : iOS建立简单的VPN连接并成功拦截IP数据包pakcet.</h3><hr>
<h3 id="建议：建议阅读本文前先仔细阅读并理解下App-extension原理，有助于在项目中解决很多问题。App-extension总结"><a href="#建议：建议阅读本文前先仔细阅读并理解下App-extension原理，有助于在项目中解决很多问题。App-extension总结" class="headerlink" title="建议：建议阅读本文前先仔细阅读并理解下App extension原理，有助于在项目中解决很多问题。App extension总结"></a>建议：建议阅读本文前先仔细阅读并理解下App extension原理，有助于在项目中解决很多问题。<a href="">App extension总结</a></h3><hr>
<h3 id="注意：Personal-VPN功能是苹果开发者账号才有权限开启，所以如果没有开发者账号次Demo无法运行"><a href="#注意：Personal-VPN功能是苹果开发者账号才有权限开启，所以如果没有开发者账号次Demo无法运行" class="headerlink" title="注意：Personal-VPN功能是苹果开发者账号才有权限开启，所以如果没有开发者账号次Demo无法运行"></a>注意：Personal-VPN功能是苹果开发者账号才有权限开启，所以如果没有开发者账号次Demo无法运行</h3><p>本Demo中已经测试可以通过，只需要下载Demo并按照Demo中所说提供两个合法的bundle id即可运行。</p>
<hr>
<h4 id="GitHub地址-附代码-XDXVPNExtensionDemo"><a href="#GitHub地址-附代码-XDXVPNExtensionDemo" class="headerlink" title="GitHub地址(附代码) : XDXVPNExtensionDemo"></a>GitHub地址(附代码) : <a href="https://github.com/ChengyangLi/XDXVPNExtensionDemo" target="_blank" rel="noopener">XDXVPNExtensionDemo</a></h4><h4 id="简书地址-XDXVPNExtensionDemo"><a href="#简书地址-XDXVPNExtensionDemo" class="headerlink" title="简书地址     : XDXVPNExtensionDemo"></a>简书地址     : <a href="https://www.jianshu.com/p/bbdb439ab5e2" target="_blank" rel="noopener">XDXVPNExtensionDemo</a></h4><h4 id="博客地址-XDXVPNExtensionDemo"><a href="#博客地址-XDXVPNExtensionDemo" class="headerlink" title="博客地址     : XDXVPNExtensionDemo"></a>博客地址     : <a href="https://chengyangli.github.io/2018/06/23/20180623_vpn_extension/" target="_blank" rel="noopener">XDXVPNExtensionDemo</a></h4><h4 id="掘金地址-XDXVPNExtensionDemo"><a href="#掘金地址-XDXVPNExtensionDemo" class="headerlink" title="掘金地址     : XDXVPNExtensionDemo"></a>掘金地址     : <a href="https://juejin.im/user/58ec343861ff4b00691b4f26/posts" target="_blank" rel="noopener">XDXVPNExtensionDemo</a></h4><hr>
<h2 id="一-App-extension-定义及工作原理"><a href="#一-App-extension-定义及工作原理" class="headerlink" title="一. App extension 定义及工作原理"></a>一. App extension 定义及工作原理</h2><h4 id="1-App-extension-更多请了解App-extension总结"><a href="#1-App-extension-更多请了解App-extension总结" class="headerlink" title="1. App extension, 更多请了解App extension总结"></a>1. App extension, 更多请了解<a href="https://juejin.im/post/5acefc0e6fb9a028e1205688" target="_blank" rel="noopener">App extension总结</a></h4><ul>
<li><p>定义：App Extension 可以让开发者们拓展自定义的功能和内容到应用程序之外，并在用户与其他应用程序或系统交互时提供给用户。</p>
</li>
<li><p>苹果定义了很多种app extension, 每一种不同功能的app extension 称为extension point,其中我们要学习的VPN Extension就是一种extension point。 </p>
</li>
</ul>
<h2 id="二-VPN-extension-简介"><a href="#二-VPN-extension-简介" class="headerlink" title="二. VPN extension 简介"></a>二. VPN extension 简介</h2><h4 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h4><p>我们先来简单了解一下国内墙的原理</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b565134cc057?w=609&amp;h=506&amp;f=png&amp;s=93467" alt="network1"></p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b56513944c9e?w=587&amp;h=845&amp;f=png&amp;s=200777" alt="network2"></p>
<h4 id="2-定义"><a href="#2-定义" class="headerlink" title="2. 定义"></a>2. 定义</h4><p>苹果提供的VPN Extension可以帮助我们配置VPN通道，自定义和拓展核心网络功能。</p>
<p>苹果官方文档中定义如下</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b56513e87746?w=553&amp;h=145&amp;f=png&amp;s=28393" alt="5-VPN Extension"></p>
<h4 id="3-使用框架"><a href="#3-使用框架" class="headerlink" title="3.使用框架"></a>3.使用框架</h4><p>NetworkExtension ：包含在iOS和macOS中用于自定义和拓展核心网络功能的API集合。</p>
<p>其中我们要讲的是NetworkExtension框架中的Personal VPN服务。</p>
<ul>
<li><p>Personal VPN </p>
<p>NEVPNManager API提供给我们去创建和管理个人VPN的配置。它通常用来向用户提供服务确保用户安全的上网，例如使用公共场所的wifi。</p>
</li>
</ul>
<h4 id="4-核心API"><a href="#4-核心API" class="headerlink" title="4. 核心API"></a>4. 核心API</h4><ul>
<li><p>NETunnelProviderManager 和 NEPacketTunnelProvider</p>
<p>在 iOS 9 中，开发者可以用 NETunnelProvider 扩展核心网络层，从而实现非标准化的私密VPN技术。最重要的两个类是 NETunnelProviderManager 和 NEPacketTunnelProvider。</p>
</li>
</ul>
<h2 id="二-VPN-extension-创建步骤"><a href="#二-VPN-extension-创建步骤" class="headerlink" title="二. VPN extension 创建步骤"></a>二. VPN extension 创建步骤</h2><h4 id="1-新建Target"><a href="#1-新建Target" class="headerlink" title="1. 新建Target"></a>1. 新建Target</h4><p>在已经创建好的项目中新建Target</p>
<ul>
<li>Target : 指定了应用程序中构建product的设置信息和文件,即包含App extension point的代码集合。</li>
</ul>
<blockquote>
<p>Xcode会为每一种extension point提供一个模板，每种模板里会提供特定的源文件(源文件中会包含一些示例代码)和设置信息，build这个target将会生成一个指定的二进制文件被添加到app’s bundle中。</p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b56513d8642d?w=706&amp;h=498&amp;f=png&amp;s=159278" alt="1-NewTarget"></p>
<p>在弹出列表中选择Packet Tunnel Provider,注意在最新的Xcode中该模板已经被取消，需要我们手动下载，安装好后重启Xcode即可，这里提供下载链接链接: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://pan.baidu.com/s/1V3xIljdRedmqGyp5QSwbTA</span><br><span class="line">密码: ne8x</span><br></pre></td></tr></table></figure>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b56514e6bbdd?w=764&amp;h=560&amp;f=png&amp;s=67130" alt="2-extensionList"></p>
<p>选择好后我们可以看到我们项目中的变化如下：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b565151b642d?w=946&amp;h=270&amp;f=png&amp;s=69441" alt="4-target"></p>
<p>我们的项目中增加了对Target的配置，左侧项目工程文件中增加了系统为我们自动生成的模板，注意如果在新建Target时选择的是Ojective-C语言模板中有一处错误信息，因为与我们要实现的并无关联，模板中代码我们均不使用，忽略即可。</p>
<h4 id="2-删除模板中多余代码"><a href="#2-删除模板中多余代码" class="headerlink" title="2. 删除模板中多余代码"></a>2. 删除模板中多余代码</h4><p>由于我们这里只演示简单的建立连接的过程，所以模板中生成的很多代码使用不到，我们只需要留下如下代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (void)startTunnelWithOptions:(NSDictionary *)options completionHandler:(void (^)(NSError *))completionHandler</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)stopTunnelWithReason:(NEProviderStopReason)reason completionHandler:(void (^)(void))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    // Add code here to start the process of stopping the tunnel</span><br><span class="line">    [self.connection cancel];</span><br><span class="line">    completionHandler();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们需要建立和断开连接的回调即可。此时Build通过。</p>
<h4 id="3-配置VPN所需信息"><a href="#3-配置VPN所需信息" class="headerlink" title="3. 配置VPN所需信息"></a>3. 配置VPN所需信息</h4><h5 id="3-1-配置签名信息，开启权限"><a href="#3-1-配置签名信息，开启权限" class="headerlink" title="3-1. 配置签名信息，开启权限"></a>3-1. 配置签名信息，开启权限</h5><ul>
<li><p>Personal-VPN功能是苹果开发者账号才有权限开启，所以如果没有开发者账号此Demo无法运行。</p>
</li>
<li><p>Bundle Identifier不可随意写，需要按照规范com.xxx.xxx形式来书写，否则Build会出错</p>
</li>
<li><p>因为vpn extension并不是一个独立的app,所以创建target时前缀必须为主app的前缀再.extensionName.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">主app  Bundle Identifier : com.xdx.XDXRouterDemo.XDXVPNExtensionDemo</span><br><span class="line"></span><br><span class="line">extension Bundle Identifier : com.xdx.XDXRouterDemo.XDXVPNExtensionDemo.XDXVPNTunnelDemo</span><br></pre></td></tr></table></figure>
<h5 id="3-2-开启权限"><a href="#3-2-开启权限" class="headerlink" title="3-2 开启权限"></a>3-2 开启权限</h5><ul>
<li>因为personal vpn权限较高，不能直接在Xcode中打开，所以我们需要先登录<a href="https://developer.apple.com/" target="_blank" rel="noopener">苹果开发者中心</a></li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b5653b48f9e2?w=500&amp;h=42&amp;f=png&amp;s=16563" alt="8-selectAccount"></p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b5653ec6c2a7?w=495&amp;h=396&amp;f=png&amp;s=39669" alt="9-selectProfile"></p>
<ul>
<li><p>需要手动为主工程的target和vpn的target创建父子App ID。创建APP ID的方法网上较多，不再说明。</p>
</li>
<li><p>在创建APP ID时打开Service 中的<br>Network Extensions 和<br>Personal VPN两个功能。对于已经创建好的APP ID需要在编辑中增加这两个Service。</p>
</li>
</ul>
<blockquote>
<p>注意：主target和extension target 对应的app id中都需要打开这两个权限。</p>
</blockquote>
<ul>
<li>创建好APP ID后需要继续创建Profile文件，如果是已经存在的app id中增加了这两项服务后需要重新激活配置文件Profile。</li>
</ul>
<h5 id="3-3-在Xcode中配置VPN"><a href="#3-3-在Xcode中配置VPN" class="headerlink" title="3-3 在Xcode中配置VPN"></a>3-3 在Xcode中配置VPN</h5><ul>
<li>在两个Target中选择正确的Profile。（前提是在3-2中正确配置了APP ID并开启了对应两项服务）由于我们只是测试，所以这里只配置了开发证书.</li>
<li>在Capabilities中开启Personal VPN 和 Network Extension（同时如图勾选前三项），然后你的两个Target项目文件中会新增两个.entitlements结尾的配置文件。</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b56541d65f39?w=1893&amp;h=750&amp;f=png&amp;s=292199" alt="12-XcodeConfig"></p>
<h4 id="4-实现步骤"><a href="#4-实现步骤" class="headerlink" title="4. 实现步骤"></a>4. 实现步骤</h4><h5 id="4-1-导入必需框架"><a href="#4-1-导入必需框架" class="headerlink" title="4-1 导入必需框架"></a>4-1 导入必需框架</h5><p>在项目中导入NetworkExtension.framework框架<br><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b565475d5369?w=962&amp;h=491&amp;f=png&amp;s=148497" alt="13-exportNE"></p>
<p>之后在主控制器导入<code>#import &lt;NetworkExtension/NetworkExtension.h&gt;</code></p>
<h5 id="4-1-初始化并配置NETunnelProviderManager对象"><a href="#4-1-初始化并配置NETunnelProviderManager对象" class="headerlink" title="4-1 初始化并配置NETunnelProviderManager对象"></a>4-1 初始化并配置NETunnelProviderManager对象</h5><ul>
<li><p>NETunnelProviderManager ：配置并控制由Tunnel Provider app extension提供的VPN 连接。</p>
<blockquote>
<p>可以理解为建立VPN连接前负责配置基本参数信息保存设置到系统(即一般vpn app中都会在第一次打开时授权并保存到系统的VPN设置中)</p>
</blockquote>
</li>
<li><p>包含Packet Tunnel Provider extension的containing app使用NETunnelProviderManager去创建和管理使用自定义协议配置VPN。</p>
</li>
</ul>
<h4 id="注意：配置好的NETunnelProviderManager对象仅在系统设置中起展示作用，或者说这里的设置并不真正生效，真正生效的设置在app-extension-target中，如果为了保持一致，如果仅仅测试，配置信息可以随便填写（但target-bundle-id-必须为项目target真实的ID），如果为了与vpn真正配置保持一致，可填写正确地址。"><a href="#注意：配置好的NETunnelProviderManager对象仅在系统设置中起展示作用，或者说这里的设置并不真正生效，真正生效的设置在app-extension-target中，如果为了保持一致，如果仅仅测试，配置信息可以随便填写（但target-bundle-id-必须为项目target真实的ID），如果为了与vpn真正配置保持一致，可填写正确地址。" class="headerlink" title="注意：配置好的NETunnelProviderManager对象仅在系统设置中起展示作用，或者说这里的设置并不真正生效，真正生效的设置在app extension target中，如果为了保持一致，如果仅仅测试，配置信息可以随便填写（但target bundle id 必须为项目target真实的ID），如果为了与vpn真正配置保持一致，可填写正确地址。"></a>注意：配置好的NETunnelProviderManager对象仅在系统设置中起展示作用，或者说这里的设置并不真正生效，真正生效的设置在app extension target中，如果为了保持一致，如果仅仅测试，配置信息可以随便填写（但target bundle id 必须为项目target真实的ID），如果为了与vpn真正配置保持一致，可填写正确地址。</h4><hr>
<h3 id="知识点，了解可跳过"><a href="#知识点，了解可跳过" class="headerlink" title="知识点，了解可跳过"></a>知识点，了解可跳过</h3><h5 id="知识点-1-区别"><a href="#知识点-1-区别" class="headerlink" title="知识点 1. 区别"></a>知识点 1. 区别</h5><h5 id="NETunnelProviderManager类继承了-NEVPNManager大多数基本的功能，主要的区别如下："><a href="#NETunnelProviderManager类继承了-NEVPNManager大多数基本的功能，主要的区别如下：" class="headerlink" title="NETunnelProviderManager类继承了 NEVPNManager大多数基本的功能，主要的区别如下："></a>NETunnelProviderManager类继承了 NEVPNManager大多数基本的功能，主要的区别如下：</h5><ul>
<li>protocolConfiguration 属性只有 NETunnelProviderProtocol类才能设置</li>
<li>connection这个只读属性只能通过 NETunnelProviderSession这个类设置。</li>
</ul>
<p>每个NETunnelProviderManager实例对应一个VPN配置被存储在 Network Extension偏好设置中。可以创建多个NETunnelProviderManager实例来管理多个VPN配置的。</p>
<p>使用NETunnelProviderManager创建的VPN配置被归属为常规企业VPN配置(而不是由NEVPNManager创建的个人VPN)。一次只能在系统启用一个VPN配置。如果同时在系统中激活个人VPN和企业VPN,企业VPN优先使用。</p>
<h5 id="知识点-2-将网络数据路由到VPN两种方式"><a href="#知识点-2-将网络数据路由到VPN两种方式" class="headerlink" title="知识点 2. 将网络数据路由到VPN两种方式"></a>知识点 2. 将网络数据路由到VPN两种方式</h5><ul>
<li><p>IP 地址</p>
<p>这是默认的路由方式。IP通道通过Packet Tunnel Provider extension被标记在VPN通道完全被建立。</p>
</li>
<li><p>By source application (Per-App VPN)</p>
<p>Per-App VPN 应用程序规则同时用于路由规则和VPN 需求规则。这与基于路由的IP地址形成鲜明的对比，当onDemandEnabled属性被设置成true并且app匹配he Per-App VPN规则试图通过网络进行通信，VPN将自动开始。</p>
</li>
</ul>
<hr>
<h5 id="4-2-初始化NETunnelProviderManager对象"><a href="#4-2-初始化NETunnelProviderManager对象" class="headerlink" title="4-2  初始化NETunnelProviderManager对象"></a>4-2  初始化NETunnelProviderManager对象</h5><ul>
<li><p>设置NETunnelProviderManager所需的各个参数的值</p>
<p>在本例中利用各个参数的值均用模型实现，在主控制器直接调用以下即可</p>
</li>
</ul>
<blockquote>
<p>注意</p>
</blockquote>
<ul>
<li>TunnelBundleId 需要传入VPN Extension Target 的BundleID</li>
<li>serverAddress:即在手机设置的VPN中显示的VPN地址</li>
<li>其余参数根据真实情况填写，如果只是测试即可直接用以下参数(或设置其他参数也可)</li>
<li>以下参数只是在系统设置中VPN设置里显示的参数，真正设置网络参数在VPN Target项目中重新设置。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[model configureInfoWithTunnelBundleId:@&quot;com.xxx.xxx.xxxx&quot;</span><br><span class="line">                         serverAddress:@&quot;10.10.10.1&quot;</span><br><span class="line">                            serverPort:@&quot;54345&quot;</span><br><span class="line">                                   mtu:@&quot;1400&quot;</span><br><span class="line">                                    ip:@&quot;10.8.0.2&quot;</span><br><span class="line">                                subnet:@&quot;255.255.255.0&quot;</span><br><span class="line">                                   dns:@&quot;8.8.8.8,8.4.4.4&quot;];</span><br></pre></td></tr></table></figure>
<p>而在封装管理NETunnelProviderManager对象真正起作用的是如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">- (void)applyVpnConfiguration &#123;</span><br><span class="line">    [NETunnelProviderManager loadAllFromPreferencesWithCompletionHandler:^(NSArray&lt;NETunnelProviderManager *&gt; * _Nullable managers, NSError * _Nullable error) &#123;</span><br><span class="line">        if (managers.count &gt; 0) &#123;</span><br><span class="line">            self.vpnManager = managers[0];</span><br><span class="line">            log4cplus_error(&quot;XDXVPNManager&quot;, &quot;The vpn already configured. We will use it.&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            log4cplus_error(&quot;XDXVPNManager&quot;, &quot;The vpn config is NULL, we will config it later.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        [self.vpnManager loadFromPreferencesWithCompletionHandler:^(NSError * _Nullable error) &#123;</span><br><span class="line">            if (error != 0) &#123;</span><br><span class="line">                const char *errorInfo = [NSString stringWithFormat:@&quot;%@&quot;,error].UTF8String;</span><br><span class="line">                log4cplus_error(&quot;XDXVPNManager&quot;, &quot;applyVpnConfiguration loadFromPreferencesWithCompletionHandler Failed - %s !&quot;,errorInfo);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            NETunnelProviderProtocol *protocol = [[NETunnelProviderProtocol alloc] init];</span><br><span class="line">            protocol.providerBundleIdentifier  = self.vpnConfigurationModel.tunnelBundleId;</span><br><span class="line">            </span><br><span class="line">            NSMutableDictionary *configInfo = [NSMutableDictionary dictionary];</span><br><span class="line">            [configInfo safeSetObject:self.vpnConfigurationModel.serverPort       forKey:@&quot;port&quot;];</span><br><span class="line">            [configInfo safeSetObject:self.vpnConfigurationModel.serverAddress    forKey:@&quot;server&quot;];</span><br><span class="line">            [configInfo safeSetObject:self.vpnConfigurationModel.ip               forKey:@&quot;ip&quot;];</span><br><span class="line">            [configInfo safeSetObject:self.vpnConfigurationModel.subnet           forKey:@&quot;subnet&quot;];</span><br><span class="line">            [configInfo safeSetObject:self.vpnConfigurationModel.mtu              forKey:@&quot;mtu&quot;];</span><br><span class="line">            [configInfo safeSetObject:self.vpnConfigurationModel.dns              forKey:@&quot;dns&quot;];</span><br><span class="line">            </span><br><span class="line">            protocol.providerConfiguration        = configInfo;</span><br><span class="line">            protocol.serverAddress                = self.vpnConfigurationModel.serverAddress;</span><br><span class="line">            self.vpnManager.protocolConfiguration = protocol;</span><br><span class="line">            self.vpnManager.localizedDescription  = @&quot;NEPacketTunnelVPNDemoConfig&quot;;</span><br><span class="line">            </span><br><span class="line">            [self.vpnManager setEnabled:YES];</span><br><span class="line">            [self.vpnManager saveToPreferencesWithCompletionHandler:^(NSError * _Nullable error) &#123;</span><br><span class="line">                if (error != 0) &#123;</span><br><span class="line">                    const char *errorInfo = [NSString stringWithFormat:@&quot;%@&quot;,error].UTF8String;</span><br><span class="line">                    log4cplus_error(&quot;XDXVPNManager&quot;, &quot;applyVpnConfiguration saveToPreferencesWithCompletionHandler Failed - %s !&quot;,errorInfo);</span><br><span class="line">                &#125;else &#123;</span><br><span class="line">                    [self applyVpnConfiguration];</span><br><span class="line">                    log4cplus_info(&quot;XDXVPNManager&quot;, &quot;Save vpn configuration successfully !&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码通过NETunnelProviderManager的类方法<code>+ (void)loadAllFromPreferencesWithCompletionHandler:(void (^)(NSArray&lt;NETunnelProviderManager *&gt; * __nullable managers, NSError * __nullable error))completionHandler</code>实现</p>
<ul>
<li>如果是第一次配置VPN,VPN的设置未保存在系统中，所以上述代码managers.count读取结果应该为0，需要我们做如上设置，第一次设置成功后，VPN的配置信息会保存在设置信息里，所以以后无需重复设置，只需要读取到就好。</li>
<li>注意，第一次配置时需要手机授权，如果拒绝则无法继续进行。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">此函数异步读取调用所有app创建且先前保存在本地的NETunnelProvider配置信息，并将它们在回调中以一个存放NETunnelProvider对象的数组的形式返回。</span><br><span class="line"></span><br><span class="line">+ (void)loadAllFromPreferencesWithCompletionHandler:(void (^)(NSArray&lt;NETunnelProviderManager *&gt; * __nullable managers, NSError * __nullable error))completionHandler</span><br><span class="line"></span><br><span class="line">该函数从调用者的VPN设置中加载当前VPN配置</span><br><span class="line">- (void)loadFromPreferencesWithCompletionHandler:(void (^)(NSError * __nullable error))completionHandler；</span><br></pre></td></tr></table></figure>
<p>然后将存入模型的所有参数放入一个字典，并存入NETunnelProviderProtocol对象的providerConfiguration中，该字典在tunnel建立成功后会传递给NETunnelProviders对象。最后将配置好的NETunnelProviderProtocol对象赋值给NETunnelProviderManager对象的protocolConfiguration即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">调用此方法用来保存上述配置好的VPN到本机设备的VPN设置中。</span><br><span class="line">- (void)saveToPreferencesWithCompletionHandler:(nullable void (^)(NSError * __nullable error))completionHandler;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">调用此函数会使用NEVPNConnection对象当前VPN配置来建立VPN连接。返回YES表示成功。</span><br><span class="line">[self.vpnManager.connection startVPNTunnelAndReturnError:&amp;error];</span><br><span class="line">- (BOOL)startVPNTunnelAndReturnError:(NSError **)error;</span><br><span class="line"></span><br><span class="line">调用此函数会关闭当前建立的VPN连接。</span><br><span class="line">[self.vpnManager.connection stopVPNTunnel];</span><br><span class="line">- (void)stopVPNTunnel;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-主控制器启动VPN"><a href="#4-3-主控制器启动VPN" class="headerlink" title="4-3. 主控制器启动VPN"></a>4-3. 主控制器启动VPN</h5><ul>
<li><p>在viewDidLoad中完成初始化操作</p>
<ul>
<li>初始化模型即根据实际情况对各个网络参数赋值(注意TunnelBundleId为本项目VPN Extension的BundleID)</li>
<li>对XDXVPNManager进行初始化配置模型，设置代理。</li>
<li>注册通知(NEVPNStatusDidChangeNotification)，监听VPN状态变化</li>
</ul>
</li>
<li><p>在<code>- (void)vpnDidChange:(NSNotification *)notification</code>方法中根据VPN的状态动态改变按钮状态</p>
</li>
<li>点击按钮实现开启/关闭VPN连接</li>
</ul>
<h5 id="4-4-在PacketTunnelProvider回调中完成剩余工作"><a href="#4-4-在PacketTunnelProvider回调中完成剩余工作" class="headerlink" title="4-4.在PacketTunnelProvider回调中完成剩余工作"></a>4-4.在PacketTunnelProvider回调中完成剩余工作</h5><ul>
<li>当我们在主控器调用开启VPN连接后，会进入VPN Target项目中PacketTunnelProvider文件的下述方法中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">当一个新的通道被建立会会调用此函数。我们必须通过重写该类来完成建立连接。</span><br><span class="line"></span><br><span class="line">@param : options - 在主控制调用开启VPN连接时传入的字典，可空。</span><br><span class="line">@param : completionHandler - 在该方法彻底完成时必须调用这个Block。如果不能建立连接要将错误信息传给该block,如果成功建立连接则只需将nil传给该Block.</span><br><span class="line"></span><br><span class="line">- (void)startTunnelWithOptions:(nullable NSDictionary&lt;NSString *,NSObject *&gt; *)options completionHandler:(void (^)(NSError * __nullable error))completionHandler</span><br></pre></td></tr></table></figure>
<p>注意：因为此时是处于另一个Target中，在手机相当于另一条进程，因此我们无法直接在控制台看到任何我们打印的log信息，这里我使用log4cplus则可以在我们的终端中来截获debug信息。如果你的本机装有log4cplus直接使用下面的命令即可获取信息，若未装则可以在github里直接搜索log4cplus mac版直接运行，也可以在log4cplus mac版的控制台里过滤关键字得到debug信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ deviceconsole |grep XDXVPNManager</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#define XDX_NET_MTU                        1400</span><br><span class="line">#define XDX_NET_REMOTEADDRESS              &quot;192.168.3.14&quot;</span><br><span class="line">#define XDX_NET_SUBNETMASKS                &quot;255.255.255.255&quot;</span><br><span class="line">#define XDX_NET_DNS                        &quot;223.5.5.5&quot;</span><br><span class="line">#define XDX_LOCAL_ADDRESS                  &quot;127.0.0.1&quot;</span><br><span class="line">#define XDX_NET_TUNNEL_IPADDRESS           &quot;10.10.10.10&quot;</span><br><span class="line"></span><br><span class="line">- (void)startTunnelWithOptions:(NSDictionary *)options completionHandler:(void (^)(NSError *))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    log4cplus_info(&quot;XDXVPNManager&quot;, &quot;XDXPacketTunnelManager - Start Tunel !&quot;);</span><br><span class="line">    NEPacketTunnelNetworkSettings *tunnelNetworkSettings = [[NEPacketTunnelNetworkSettings alloc] initWithTunnelRemoteAddress:@XDX_NET_REMOTEADDRESS];</span><br><span class="line">    tunnelNetworkSettings.MTU = [NSNumber numberWithInteger:XDX_NET_MTU];</span><br><span class="line">    tunnelNetworkSettings.IPv4Settings = [[NEIPv4Settings alloc] initWithAddresses:[NSArray arrayWithObjects:@XDX_NET_TUNNEL_IPADDRESS, nil]  subnetMasks:[NSArray arrayWithObjects:@XDX_NET_SUBNETMASKS, nil]];</span><br><span class="line">    tunnelNetworkSettings.IPv4Settings.includedRoutes = @[[NEIPv4Route defaultRoute]];</span><br><span class="line">    NEIPv4Settings *excludeRoute = [[NEIPv4Settings alloc] initWithAddresses:[NSArray arrayWithObjects:@&quot;10.10.10.11&quot;, nil] subnetMasks:[NSArray arrayWithObjects:@XDX_NET_SUBNETMASKS, nil]];</span><br><span class="line">    tunnelNetworkSettings.IPv4Settings.excludedRoutes = @[excludeRoute];</span><br><span class="line">    </span><br><span class="line">    [self setTunnelNetworkSettings:tunnelNetworkSettings completionHandler:^(NSError * _Nullable error) &#123;</span><br><span class="line">        if (error == nil) &#123;</span><br><span class="line">            log4cplus_info(&quot;XDXVPNManager&quot;, &quot;XDXPacketTunnelManager - Start Tunel Success !&quot;);</span><br><span class="line">            completionHandler(nil);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            log4cplus_error(&quot;XDXVPNManager&quot;, &quot;XDXPacketTunnelManager - Start Tunel Failed - %s !&quot;,error.debugDescription.UTF8String);</span><br><span class="line">            completionHandler(error);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [self.packetFlow readPacketsWithCompletionHandler:^(NSArray&lt;NSData *&gt; * _Nonnull packets, NSArray&lt;NSNumber *&gt; * _Nonnull protocols) &#123;</span><br><span class="line">        log4cplus_debug(&quot;XDXVPNManager&quot;, &quot;XDXPacketTunnelManager - Read Packet !&quot;);</span><br><span class="line">        [packets enumerateObjectsUsingBlock:^(NSData * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">            NSString *packetStr = [NSString stringWithFormat:@&quot;%@&quot;,obj];</span><br><span class="line">            log4cplus_debug(&quot;XDXVPNManager&quot;, &quot;XDXPacketTunnelManager - Read Packet - %s !&quot;,packetStr.UTF8String);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当你上述的每一步都正确配置，并在主控器中调用-startVPNTunnelAndReturnError方法时，紧接着会在vpn target中调用以上回调，我们需要在此回调中建立tunnel并配置我们需要的各种网络设置，最后在调用<code>- (void)setTunnelNetworkSettings</code>回调中调用<code>completionHandler(nil);</code>来建立vpn连接。</p>
<blockquote>
<p>注意，在设置网络参数成功后必须显式调用completionHandler(nil)才能正常建立连接(官方API要求)，如果设置网络参数出错则将错误信息传入completionHandler(error),否则无法正常建立连接。</p>
</blockquote>
<h4 id="这里是真正设置vpn-tunnel-网络参数的地方，主控制器中设置的仅为系统vpn设置中的展示名称"><a href="#这里是真正设置vpn-tunnel-网络参数的地方，主控制器中设置的仅为系统vpn设置中的展示名称" class="headerlink" title="这里是真正设置vpn tunnel 网络参数的地方，主控制器中设置的仅为系统vpn设置中的展示名称"></a>这里是真正设置vpn tunnel 网络参数的地方，主控制器中设置的仅为系统vpn设置中的展示名称</h4><ul>
<li>首先新建一个NEPacketTunnelNetworkSettings对象，此对象是用来设置并建立vpn tunnel初始化对象时提供的RemoteAddress即为我们要建立连接的远程服务器的地址，注意如果是域名需要手动解析为IP地址再传入。下面提供了方法可转换。</li>
<li>MTU:最大传输单元,即每个packet最大的容量</li>
<li>includedRoutes：即vpn tunnel需要拦截包的地址，如果全部拦截则设置[NEIPv4Route defaultRoute]，也可以指定部分需要拦截的地址</li>
<li>excludeRoute ： 设置不拦截哪些包的地址，默认不会拦截tunnel本身地址发出去的包。</li>
<li>最后调用<code>- (void)setTunnelNetworkSettings</code>，在回调若成功直接调用<code>completionHandler(nil);</code>来建立vpn连接。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;netinet/in.h&gt;</span><br><span class="line">#include &lt;netdb.h&gt;</span><br><span class="line">#include &lt;arpa/inet.h&gt;</span><br><span class="line"></span><br><span class="line">// 域名转换IP</span><br><span class="line">- (NSString *)queryIpWithDomain:(NSString *)domain &#123;</span><br><span class="line">    struct hostent *hs;</span><br><span class="line">    struct sockaddr_in server;</span><br><span class="line">    if ((hs = gethostbyname([domain UTF8String])) != NULL) &#123;</span><br><span class="line">        server.sin_addr = *((struct in_addr*)hs-&gt;h_addr_list[0]);</span><br><span class="line">        return [NSString stringWithUTF8String:inet_ntoa(server.sin_addr)];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在调用完setTunnelNetworkSettings后如果回调返回error且我们按照上述所说完成completionHandler(nil);的配置后，vpn成功建立连接，此时我们的app状态栏里也会相应出现vpn的标识，如下图。<br><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b5654a5cab4c?w=1233&amp;h=360&amp;f=png&amp;s=1365526" alt="14-VPN"></p>
<ul>
<li>附加步骤：在VPN Tunndel 中持续读取packet包<br>因为我们已经成功建立了vpn连接，所以网络数据包我们可以在此回调中截取到</li>
</ul>
<p>利用NEPacketTunnelProvider对象的packetFlow 完成下面的方法即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">从流中读入可用的IP包</span><br><span class="line">- (void)readPakcets &#123;</span><br><span class="line">    __weak PacketTunnelProvider *weakSelf = self;</span><br><span class="line">    [self.packetFlow readPacketsWithCompletionHandler:^(NSArray&lt;NSData *&gt; * _Nonnull packets, NSArray&lt;NSNumber *&gt; * _Nonnull protocols) &#123;</span><br><span class="line">        for (NSData *packet in packets) &#123;</span><br><span class="line">            // log4cplus_debug(&quot;XDXVPNManager&quot;, &quot;Read Packet - %s&quot;,[NSString stringWithFormat:@&quot;%@&quot;,packet].UTF8String);</span><br><span class="line">            __typeof__(self) strongSelf = weakSelf;</span><br><span class="line">            // TODO ...</span><br><span class="line">            </span><br><span class="line">            NSLog(@&quot;XDX : read packet - %@&quot;,packet);</span><br><span class="line">        &#125;</span><br><span class="line">        [weakSelf readPakcets];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下为我读到的包<br><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b56552117f30?w=2000&amp;h=97&amp;f=png&amp;s=192026" alt="read packet"></p>
<p>另外如需Debug app extension target可以通过Xcode如下方法<br><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b56560ee75ad?w=1500&amp;h=604&amp;f=png&amp;s=532576" alt="Debug"></p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/23/1642b56568180f18?w=400&amp;h=516&amp;f=png&amp;s=140440" alt="Debug info"></p>
<ul>
<li>停止方法较为简单，不再叙述，详细可在Demo中查阅</li>
</ul>
<h3 id="总结：此Demo为利用苹果官方提供的VPN-Extension在一个项目中通过新建Target来完成一个简单建立VPN的过程。其中涉及到App-extension的知识可在本文所附的另一篇文章中查阅，主要涉及App-extension在项目中的配置，以及建立VPN连接时一些参数的设置及方法的调用时机-以及成功建立连接后可拦截手机中的网络Packet。"><a href="#总结：此Demo为利用苹果官方提供的VPN-Extension在一个项目中通过新建Target来完成一个简单建立VPN的过程。其中涉及到App-extension的知识可在本文所附的另一篇文章中查阅，主要涉及App-extension在项目中的配置，以及建立VPN连接时一些参数的设置及方法的调用时机-以及成功建立连接后可拦截手机中的网络Packet。" class="headerlink" title="总结：此Demo为利用苹果官方提供的VPN Extension在一个项目中通过新建Target来完成一个简单建立VPN的过程。其中涉及到App extension的知识可在本文所附的另一篇文章中查阅，主要涉及App extension在项目中的配置，以及建立VPN连接时一些参数的设置及方法的调用时机,以及成功建立连接后可拦截手机中的网络Packet。"></a>总结：此Demo为利用苹果官方提供的VPN Extension在一个项目中通过新建Target来完成一个简单建立VPN的过程。其中涉及到App extension的知识可在本文所附的另一篇文章中查阅，主要涉及App extension在项目中的配置，以及建立VPN连接时一些参数的设置及方法的调用时机,以及成功建立连接后可拦截手机中的网络Packet。</h3>
      
    </div>

    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>穷则github点星,达可兼济本人</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="小东邪 - Demon WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="小东邪 - Demon Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/App-extension/" rel="tag"># App extension</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/12/appExtension/" rel="next" title="App extension 总结">
                <i class="fa fa-chevron-left"></i> App extension 总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/06/20181106_iOS_H5WechatPay/" rel="prev" title="iOS WKWebView H5微信支付跳转">
                iOS WKWebView H5微信支付跳转 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
        <div onclick="showGitment()" id="gitment_title" class="gitment_title">显示 Gitment 评论</div>
        <div id="container" style="display:none"></div>
        <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
        <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
        <script>
        const myTheme = {
          render(state, instance) {
            const container = document.createElement('div');
            container.lang = "en-US";
            container.className = 'gitment-container gitment-root-container';
            container.appendChild(instance.renderHeader(state, instance));
            container.appendChild(instance.renderEditor(state, instance));
            container.appendChild(instance.renderComments(state, instance));
            container.appendChild(instance.renderFooter(state, instance));
            return container;
          }
        }
        function showGitment() {
          $("#gitment_title").attr("style", "display:none");
          $("#container").attr("style", "").addClass("gitment_container");
          var gitment = new Gitment({
            id: window.location.pathname,
            theme: myTheme,
            owner: '',
            repo: '',
            oauth: {
              client_id: 'c209d8cfa2d7f7696f17',
              client_secret: '1681a33c8745e7a79871dfc6613170a03c44fed8'
            }
          });
          gitment.render('container');
        }
        </script>

  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://r.photo.store.qq.com/psb?/V14Id4Zj1TAt9e/yzeIpXHXXaOcxOnovNgST0jvIeuupEGzPfZ3DWoYrLY!/r/dFQBAAAAAAAA"
                alt="小东邪 - Demon" />
            
              <p class="site-author-name" itemprop="name">小东邪 - Demon</p>
              <p class="site-description motion-element" itemprop="description">一生负气成今日，四海无人对夕阳.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/XiaoDongXie1024" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.jianshu.com/u/23f3ec991fed" target="_blank" title="简书"><i class="fa fa-fw fa-book"></i>简书</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://juejin.im/user/58ec343861ff4b00691b4f26" target="_blank" title="掘金"><i class="fa fa-fw fa-star"></i>掘金</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#本例需求-iOS建立简单的VPN连接并成功拦截IP数据包pakcet"><span class="nav-number">1.</span> <span class="nav-text">本例需求 : iOS建立简单的VPN连接并成功拦截IP数据包pakcet.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建议：建议阅读本文前先仔细阅读并理解下App-extension原理，有助于在项目中解决很多问题。App-extension总结"><span class="nav-number">2.</span> <span class="nav-text">建议：建议阅读本文前先仔细阅读并理解下App extension原理，有助于在项目中解决很多问题。App extension总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意：Personal-VPN功能是苹果开发者账号才有权限开启，所以如果没有开发者账号次Demo无法运行"><span class="nav-number">3.</span> <span class="nav-text">注意：Personal-VPN功能是苹果开发者账号才有权限开启，所以如果没有开发者账号次Demo无法运行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GitHub地址-附代码-XDXVPNExtensionDemo"><span class="nav-number">3.1.</span> <span class="nav-text">GitHub地址(附代码) : XDXVPNExtensionDemo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#简书地址-XDXVPNExtensionDemo"><span class="nav-number">3.2.</span> <span class="nav-text">简书地址     : XDXVPNExtensionDemo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#博客地址-XDXVPNExtensionDemo"><span class="nav-number">3.3.</span> <span class="nav-text">博客地址     : XDXVPNExtensionDemo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#掘金地址-XDXVPNExtensionDemo"><span class="nav-number">3.4.</span> <span class="nav-text">掘金地址     : XDXVPNExtensionDemo</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一-App-extension-定义及工作原理"><span class="nav-number"></span> <span class="nav-text">一. App extension 定义及工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-App-extension-更多请了解App-extension总结"><span class="nav-number">0.1.</span> <span class="nav-text">1. App extension, 更多请了解App extension总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-VPN-extension-简介"><span class="nav-number"></span> <span class="nav-text">二. VPN extension 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-背景"><span class="nav-number">0.1.</span> <span class="nav-text">1. 背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-定义"><span class="nav-number">0.2.</span> <span class="nav-text">2. 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-使用框架"><span class="nav-number">0.3.</span> <span class="nav-text">3.使用框架</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-核心API"><span class="nav-number">0.4.</span> <span class="nav-text">4. 核心API</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-VPN-extension-创建步骤"><span class="nav-number"></span> <span class="nav-text">二. VPN extension 创建步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-新建Target"><span class="nav-number">0.1.</span> <span class="nav-text">1. 新建Target</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-删除模板中多余代码"><span class="nav-number">0.2.</span> <span class="nav-text">2. 删除模板中多余代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-配置VPN所需信息"><span class="nav-number">0.3.</span> <span class="nav-text">3. 配置VPN所需信息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-配置签名信息，开启权限"><span class="nav-number">0.3.1.</span> <span class="nav-text">3-1. 配置签名信息，开启权限</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-开启权限"><span class="nav-number">0.3.2.</span> <span class="nav-text">3-2 开启权限</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-在Xcode中配置VPN"><span class="nav-number">0.3.3.</span> <span class="nav-text">3-3 在Xcode中配置VPN</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-实现步骤"><span class="nav-number">0.4.</span> <span class="nav-text">4. 实现步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-导入必需框架"><span class="nav-number">0.4.1.</span> <span class="nav-text">4-1 导入必需框架</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-初始化并配置NETunnelProviderManager对象"><span class="nav-number">0.4.2.</span> <span class="nav-text">4-1 初始化并配置NETunnelProviderManager对象</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注意：配置好的NETunnelProviderManager对象仅在系统设置中起展示作用，或者说这里的设置并不真正生效，真正生效的设置在app-extension-target中，如果为了保持一致，如果仅仅测试，配置信息可以随便填写（但target-bundle-id-必须为项目target真实的ID），如果为了与vpn真正配置保持一致，可填写正确地址。"><span class="nav-number">0.5.</span> <span class="nav-text">注意：配置好的NETunnelProviderManager对象仅在系统设置中起展示作用，或者说这里的设置并不真正生效，真正生效的设置在app extension target中，如果为了保持一致，如果仅仅测试，配置信息可以随便填写（但target bundle id 必须为项目target真实的ID），如果为了与vpn真正配置保持一致，可填写正确地址。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#知识点，了解可跳过"><span class="nav-number">1.</span> <span class="nav-text">知识点，了解可跳过</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#知识点-1-区别"><span class="nav-number">1.0.1.</span> <span class="nav-text">知识点 1. 区别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NETunnelProviderManager类继承了-NEVPNManager大多数基本的功能，主要的区别如下："><span class="nav-number">1.0.2.</span> <span class="nav-text">NETunnelProviderManager类继承了 NEVPNManager大多数基本的功能，主要的区别如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#知识点-2-将网络数据路由到VPN两种方式"><span class="nav-number">1.0.3.</span> <span class="nav-text">知识点 2. 将网络数据路由到VPN两种方式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-初始化NETunnelProviderManager对象"><span class="nav-number">1.0.4.</span> <span class="nav-text">4-2  初始化NETunnelProviderManager对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-主控制器启动VPN"><span class="nav-number">1.0.5.</span> <span class="nav-text">4-3. 主控制器启动VPN</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-4-在PacketTunnelProvider回调中完成剩余工作"><span class="nav-number">1.0.6.</span> <span class="nav-text">4-4.在PacketTunnelProvider回调中完成剩余工作</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#这里是真正设置vpn-tunnel-网络参数的地方，主控制器中设置的仅为系统vpn设置中的展示名称"><span class="nav-number">1.1.</span> <span class="nav-text">这里是真正设置vpn tunnel 网络参数的地方，主控制器中设置的仅为系统vpn设置中的展示名称</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结：此Demo为利用苹果官方提供的VPN-Extension在一个项目中通过新建Target来完成一个简单建立VPN的过程。其中涉及到App-extension的知识可在本文所附的另一篇文章中查阅，主要涉及App-extension在项目中的配置，以及建立VPN连接时一些参数的设置及方法的调用时机-以及成功建立连接后可拦截手机中的网络Packet。"><span class="nav-number">2.</span> <span class="nav-text">总结：此Demo为利用苹果官方提供的VPN Extension在一个项目中通过新建Target来完成一个简单建立VPN的过程。其中涉及到App extension的知识可在本文所附的另一篇文章中查阅，主要涉及App extension在项目中的配置，以及建立VPN连接时一些参数的设置及方法的调用时机,以及成功建立连接后可拦截手机中的网络Packet。</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小东邪 - Demon</span>

  

  
</div>








  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.4.2</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.2"></script>



  



  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'XiaoDongXie1024',
            repo: 'gitment-comments',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '1681a33c8745e7a79871dfc6613170a03c44fed8',
            
                client_id: 'c209d8cfa2d7f7696f17'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    






  





  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.time + 1);
            })
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text('Counter not initialized! See more at console err msg.');
              console.error('ATTENTION! LeanCloud counter has security bug, see here how to solve it: https://github.com/theme-next/hexo-leancloud-counter-security. \n But you also can use LeanCloud without security, by set \'security\' option to \'false\'.');
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "",
                'X-LC-Key': "",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  

  
  

  

  

  

  

  

</body>
</html>
